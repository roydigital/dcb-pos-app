<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi Chicken Brothers - POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gray-800 p-4 flex justify-between items-center shadow-md">
            <h1 class="text-2xl font-bold text-white">DELHI CHICKEN BROTHERS</h1>
            <div id="current-time" class="text-lg font-semibold text-gray-300">11:46 AM</div>
        </header>

        <!-- Navigation Bar -->
        <nav class="bg-gray-800 border-t border-b border-gray-700">
            <div class="flex">
                <a href="index.html" class="px-6 py-3 text-lg font-medium bg-red-600 text-white border-r border-gray-700">Point of Sale</a>
                <a href="live-orders.html" class="px-6 py-3 text-lg font-medium text-gray-400 hover:bg-gray-700 border-r border-gray-700">Live Orders</a>
                <a href="reports.html" class="px-6 py-3 text-lg font-medium text-gray-400 hover:bg-gray-700 border-r border-gray-700">Reports</a>
                <a href="menu-management.html" class="px-6 py-3 text-lg font-medium text-gray-400 hover:bg-gray-700">Menu Management</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow flex p-4 space-x-4 overflow-hidden">
            <!-- Left Column: Menu -->
            <div class="w-5/12 bg-gray-800 rounded-lg p-4 flex flex-col">
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg mb-4">
                    Manage Menu
                </button>
                <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto flex-grow">
                    <!-- Menu items will be dynamically inserted here -->
                </div>
            </div>

            <!-- Middle Column: Current Order -->
            <div class="w-4/12 bg-gray-800 rounded-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Current Order</h2>
                <div id="order-items" class="flex-grow flex items-center justify-center">
                    <p class="text-gray-500">Click on a menu item to start an order.</p>
                </div>
            </div>

            <!-- Right Column: Order Finalization -->
            <div class="w-3/12 bg-gray-800 rounded-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Details</h2>
                <div class="space-y-4">
                    <div class="relative">
                        <label for="customer-name" class="block text-sm font-medium text-gray-400">Customer Name (Optional)</label>
                        <input type="text" id="customer-name" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="phone-number" class="block text-sm font-medium text-gray-400">Phone Number (Optional)</label>
                        <input type="tel" id="phone-number" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Payment Mode</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="payment-mode" value="upi" class="form-radio h-4 w-4 text-red-600 bg-gray-700 border-gray-600 focus:ring-red-500" checked>
                                <span class="ml-2 text-white">UPI</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="payment-mode" value="cash" class="form-radio h-4 w-4 text-red-600 bg-gray-700 border-gray-600 focus:ring-red-500">
                                <span class="ml-2 text-white">Cash</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold">Total:</span>
                        <span id="total-amount" class="text-3xl font-bold text-white">₹0.00</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="clear-order-btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg">
                            Clear
                        </button>
                        <button id="finalize-bill-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            Finalize Bill
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentOrder = [];

        async function populateMenu() {
            const menuGrid = document.getElementById('menu-grid');
            menuGrid.innerHTML = ''; // Clear existing items

            try {
                const response = await fetch('http://localhost:3002/api/menu');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const menuData = await response.json();

                menuData.forEach(item => {
                    item.prices.forEach(priceInfo => {
                    const button = document.createElement('button');
                    button.className = 'bg-gray-700 hover:bg-red-600 text-white font-semibold py-3 px-2 rounded-lg text-sm flex flex-col justify-center items-center shadow-lg transition-colors duration-200';
                    
                    let itemName = item.name;
                    if (priceInfo.size !== 'Standard') {
                        itemName += ` (${priceInfo.size})`;
                    }
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = itemName;
                    nameSpan.className = 'text-center';

                    const priceSpan = document.createElement('span');
                    priceSpan.textContent = `₹${priceInfo.price.toFixed(2)}`;
                    priceSpan.className = 'text-lg font-bold mt-1';

                    button.appendChild(nameSpan);
                    button.appendChild(priceSpan);
                    
                    button.addEventListener('click', () => addToOrder(itemName, priceInfo.price));
                    
                    menuGrid.appendChild(button);
                    });
                });
            } catch (error) {
                console.error("Failed to fetch menu:", error);
                menuGrid.innerHTML = `<p class="text-red-400 col-span-full text-center">Failed to load menu. Please check the connection and try again.</p>`;
            }
        }

        function addToOrder(itemName, itemPrice) {
            const existingItem = currentOrder.find(item => item.name === itemName);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentOrder.push({ name: itemName, price: itemPrice, quantity: 1 });
            }
            renderOrder();
        }

        function renderOrder() {
            const orderItemsDiv = document.getElementById('order-items');
            orderItemsDiv.innerHTML = '';

            if (currentOrder.length === 0) {
                orderItemsDiv.innerHTML = '<p class="text-gray-500">Click on a menu item to start an order.</p>';
                orderItemsDiv.classList.add('flex', 'items-center', 'justify-center');
            } else {
                orderItemsDiv.classList.remove('flex', 'items-center', 'justify-center');
                const ul = document.createElement('ul');
                ul.className = 'space-y-2 w-full';

                currentOrder.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';

                    const nameAndQty = document.createElement('div');
                    nameAndQty.className = 'flex items-center';
                    
                    const qtySpan = document.createElement('span');
                    qtySpan.textContent = `${item.quantity}x`;
                    qtySpan.className = 'font-bold mr-2';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = item.name;

                    nameAndQty.appendChild(qtySpan);
                    nameAndQty.appendChild(nameSpan);

                    const priceAndControls = document.createElement('div');
                    priceAndControls.className = 'flex items-center';

                    const priceSpan = document.createElement('span');
                    priceSpan.textContent = `₹${(item.price * item.quantity).toFixed(2)}`;
                    priceSpan.className = 'font-bold mr-4';

                    const controls = document.createElement('div');
                    controls.className = 'flex items-center space-x-2';

                    const plusBtn = document.createElement('button');
                    plusBtn.textContent = '+';
                    plusBtn.className = 'bg-green-500 hover:bg-green-600 text-white font-bold w-6 h-6 rounded-full';
                    plusBtn.onclick = () => {
                        item.quantity++;
                        renderOrder();
                    };

                    const minusBtn = document.createElement('button');
                    minusBtn.textContent = '-';
                    minusBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-bold w-6 h-6 rounded-full';
                    minusBtn.onclick = () => {
                        item.quantity--;
                        if (item.quantity === 0) {
                            currentOrder.splice(index, 1);
                        }
                        renderOrder();
                    };

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&#128465;'; // Trash can icon
                    removeBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center';
                    removeBtn.onclick = () => {
                        currentOrder.splice(index, 1);
                        renderOrder();
                    };

                    controls.appendChild(plusBtn);
                    controls.appendChild(minusBtn);
                    controls.appendChild(removeBtn);

                    priceAndControls.appendChild(priceSpan);
                    priceAndControls.appendChild(controls);

                    li.appendChild(nameAndQty);
                    li.appendChild(priceAndControls);
                    ul.appendChild(li);
                });
                orderItemsDiv.appendChild(ul);
            }

            const totalAmount = currentOrder.reduce((total, item) => total + (item.price * item.quantity), 0);
            document.getElementById('total-amount').textContent = `₹${totalAmount.toFixed(2)}`;
        }

        function updateTime() {
            const timeEl = document.getElementById('current-time');
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function showTemporaryMessage(message, isError = false) {
            const messageContainer = document.createElement('div');
            messageContainer.textContent = message;
            messageContainer.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white font-semibold shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            document.body.appendChild(messageContainer);

            setTimeout(() => {
                messageContainer.remove();
            }, 3000); // Message disappears after 3 seconds
        }

        async function handleFinalizeBill() {
            if (currentOrder.length === 0) {
                showTemporaryMessage("Cannot finalize an empty order.", true);
                return;
            }

            const totalAmount = currentOrder.reduce((total, item) => total + (item.price * item.quantity), 0);
            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('phone-number').value;
            const paymentMode = document.querySelector('input[name="payment-mode"]:checked').value;

            const orderData = {
                items: currentOrder,
                totalAmount: totalAmount,
                customerName: customerName,
                customerPhone: customerPhone,
                paymentMode: paymentMode
            };

            try {
                const response = await fetch('http://localhost:3002/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Order successful:', result);
                    showTemporaryMessage("Order Finalized Successfully!");
                    
                    // Clear order and inputs
                    currentOrder = [];
                    renderOrder();
                    document.getElementById('customer-name').value = '';
                    document.getElementById('phone-number').value = '';
                } else {
                    const errorData = await response.json();
                    console.error('Error finalizing order:', errorData);
                    showTemporaryMessage(`Error: ${errorData.message || 'Could not finalize order.'}`, true);
                }
            } catch (error) {
                console.error('Network or fetch error:', error);
                showTemporaryMessage("A network error occurred. Please try again.", true);
            }
        }

        document.getElementById('clear-order-btn').addEventListener('click', () => {
            currentOrder = [];
            renderOrder();
        });

        document.getElementById('finalize-bill-btn').addEventListener('click', handleFinalizeBill);

        // Initial calls
        populateMenu();
        updateTime();
        setInterval(updateTime, 1000); // Update time every second
    </script>
</body>
</html>
